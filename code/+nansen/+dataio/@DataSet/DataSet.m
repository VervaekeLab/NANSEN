classdef DataSet < uiw.mixin.AssignPVPairs
    
    properties % Immutable? Should not be possible to change
        DataSetID = ''  % ID which identifies files that belong to dataset.
    end

    properties
        IsArchive = false
    end

    properties (Access = private)
        DataIOModel % DataLocationModel, VariableModel
    end

    properties (Access = private)
        DatePrefixStr_
    end

    methods (Abstract)
        
%         existVariable
%
%         existFolder
%
%         getDatasetFolderpath

        getDataFilePath

        saveData

        loadData

    end
    
    methods % Set/get
        
        function set.IsArchive(obj, newValue)
            assert(islogical(newValue), 'Value must be logical')
            obj.IsArchive = newValue;
            obj.onIsArchiveSet()
        end
    end

    methods (Access = protected)

        function [mode, varargin] = checkDataFilePathMode(~, varargin)
        %checkDataFilePathMode Check mode for retrieving filepath
        %
        %   When retrieving the filepath for a data variable, a flag is
        %   used to specify if the data should be read or written. The flag
        %   for read is '-r' and the flag for write is '-w'.
        %
        %   This function looks for the read/write flag in the first item
        %   of a varargin cell array and returns the mode flag as the first
        %   output and the remaining items from the varargin cell array as
        %   a second output.

            % Default mode is read:
            mode = 'read';
            
            if ~isempty(varargin) && ischar(varargin{1})
                switch varargin{1}
                    case '-r'
                        mode = 'read';
                        varargin = varargin(2:end);
                    case '-w'
                        mode = 'write';
                        varargin = varargin(2:end);
                end
            end
        end

        function fileName = createFileName(obj, varName, parameters)
        %createFileName Create a filename given a variable name
        %
        %   fileName = createFileName(obj, varName, parameters) create a
        %   filename given a variable name, varName.
        %
        %   INPUTS:
        %       varName : character vector specifying a variable name
        %       parameters : optional struct containing the field FileType
        %
        %   The variable name is generated by converting the varname from
        %   camelcase to snakecase and prepending the dataset id. If
        %   filetype is not specified, the default is to use the .mat
        %   file extension.

            % Make the name into snake case before creating the filename
            fileName = utility.string.camel2snake(varName);

            % Fix special case:
            fileName = strrep(fileName, '__', '_');
            
            % Combine variable name and data set id
            if ~isempty(obj.DataSetID)
                fileName = strjoin({obj.DataSetID, fileName}, '_');
            end
            
            % Append a file extension
            if isfield(parameters, 'FileType')
                fileExtension = parameters.FileType;
                if ~strncmp(fileExtension, '.', 1)
                    fileExtension = strcat('.', fileExtension);
                end
            else
                fileExtension = '.mat';
            end
            fileName = strcat(fileName, fileExtension);
        end

        function onIsArchiveSet(obj)
            %todo
        end
    end

    methods (Access = protected)
        
        function str = getDatePrefix(obj)
            
            if isempty(obj.DatePrefixStr_)
                obj.DatePrefixStr_ = datestr(now, 'yyyymmdd_HH_MM_SS');
            end

            if obj.IsArchive
                str = obj.DatePrefixStr_;
            else
                str = '';
            end
        end
    end
end

% createDataSet(folderPath, name, value)

% For flowreg/normcorre

% Source can be a filepath or an imagestack (which links to a filepath).

%% Dataset types...

% file -> folder

% folder -> folder

% folderA -> folderB

% folderA <-> folderB

%% Dataset modes
% archive yes/no. I.e should the dataset be timestamped?
